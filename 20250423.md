# Information
- **Time:** 13:20 - 
- **Attendees:** Bob Zhang (Supervisor), Huang Yanzhen, Mai Jiajun

# Discussion Summary
## 1 Frontend & Storage Backend
### 1.1 Security
Done with this [issue](https://github.com/FYP-hyz-mjj-2024/posture-video-stream/issues/3).
- Frontend: Migrated JWT token from `localStorage` to `cookies`.
- Frontend & Storage Backend: Migrated JWT from payload to `Authorization` Fields.
	- Auth related ORMs in storage backend used to have meta-class of `UserAuth`.
	- Now all meta-classes of auth ORMs are `WithUserId`.
	- Same for Frontend.
- Deployed this change to cloud at [commit](https://github.com/FYP-hyz-mjj-2024/posture-face-compare/commit/23b4e00bcc17bdc74d7e5d09a9bc15045f85a85e.) in storage backend.
### 1.2 Extendability & Maintainability
#### 1.2.1 Naming Paradigm
A naming paradigm is consolidated among the frontend and the storage backend.

Function name: `verbNoun`

```typescript
async function uploadFace (
	faceUploadSubmit: FaceUploadSubmit,
	callbacks: RequestCallbacks<T>,
){
// do sth.
}
```

Preliminary submission type name: `NounVerbSubmit`
- A `javascript` object when submitted from an `HTML` form, not containing user authentication information.

```typescript
type FaceUploadSubmit = {blob: string, description: string}
```

Final request body type: `NounVerb`
- A `javascript` object containing user authentication information.
- Used to also contain `token`, now migrated to `HTTP`'s `Authorization` header field.

```typescript
type WithUserId = {user_id: string};
type FaceUpload = FaceUploadSubmit & WithUserId;
```

Variable Name: `nounVerb`

```typescript
const faceUpload = {
	user_id: user_id,
	...faceUploadSubmit
}
```

Response type name: `NounVerbResult`

```typescript
interface UsersGetResult {
	num_total: number,
	num_this_page: number,
	users: UserSuper[],
};
```

#### 1.2.2 Closures and Callbacks
Encapsulated and centralized more server features (i.e., `axios` request functions) to `/lib/server.ts`. A server function will have three callbacks:
	- `onAuthFailCallback`: Callback function when authentication failed.
	- `onSuccessCallback`: Callback function when requests responded successfully.
	- `onFailCallback`: Callback when requests responded a fail or other error occurs.

Definition of a server function: 

```typescript
export async function verbNoun(
	nounVerbSubmit: NounVerbSubmit,
	callbacks: {
		onAuthFailCallback: (e: any) => void,
		onSuccessCallback: (response: AxiosResponse<NounVerbResult>) => void,
		onFailCallback: (e: any) => void
	}
) {
	// 1. Obtain user authentication from local.
	const { user_id, token } = _getUserAuth();
	if (!user_id || !token) {
		callbacks.onAuthFailCallback({
			localMessage: "Your login info is expired. Please re-login."
		});
		return null;
	}

	// 2. Inject user id into the function.
	const nounVerb: nounVerb = {
		user_id: user_id,
		...nounVerbSubmit
	}

	// 3. Post a request.
	await axios.post(
		`${process.env.NEXT_PUBLIC_DB_DOMAIN}/field/service/`,
		nounVerb,
		{
			headers: { // 3.1 Migrated token to authorization field.
				"Authorization": `Bearer ${token}`,
			}
		}
	).then((response) => {
		if (!response) { // 3.2 Invoke corresponding callbacks.
			callbacks.onFailCallback("Response is empty.");
			return null;
		}
		callbacks.onSuccessCallback(response);
	}).catch((e: AxiosError) => {
		callbacks.onFailCallback(e);
	});
}
```

Usage of a server function:

```typescript
// Webpage .tsx
useState(()=>{
	verbNoun(
		nounVerbSubmit,
		{
			onAuthFailCallback: (e)=>{
				const msg = _getErrorMessage(e);
				window.alert(msg);
				router.push("/"); // Push to a public page.
			},
			onSuccessCallback: (res) => {
				const data = res.data;
				setData(data);  // Set a new data state for re-render.
			},
			onFailCallback: (e) => {
				const msg = _getErrorMessage(e);
				window.alert(msg); // Error handling.
			}
		});
}, [dependency])
```